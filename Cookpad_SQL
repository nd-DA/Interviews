--Check if there is duration in front of recipe view
SELECT * from narnia_cp
where event in ('recipe.visit')
and view_duration not in ('NULL')

--Check if there is no duration in front of visit duration
SELECT * from narnia_cp
where event in ('visit_duration')
and view_duration in ('NULL')



/*
Based on event i am deviding the events into 2 categories, where we can prompt a dialogue box for sharing cooksnap and where we cannot
including events 'recipe.react', 'recipe.bookmark', 'recipe.cooked_it', 'cookplan.comments.create', 'user.follow', 'recipe.add_to_cookplan' and 'view_duration' where duration >= 600 IN Y
else No
*/


SELECT count(*)

FROM
	(
	Select 
	aa.*,
	CASE WHEN aa.event in ('recipe.react', 'recipe.bookmark', 'recipe.cooked_it', 'cookplan.comments.create', 'user.follow', 'recipe.add_to_cookplan') then 'Y'
		WHEN aa.event in ('recipe.share', 'recipe.edit.open', 'recipe.comments.visit', 'recipe.publish', 'recipe.visit', 'cooksnap.create') then 'N'
		WHEN aa.event in ('view_duration') AND aa.view_duration >= 600 THEN 'Y'
		WHEN aa.event in ('view_duration') AND aa.view_duration < 600 THEN 'N'
		ELSE 'N' 
		END AS CS_Notify

	FROM
		(
		SELECT 
			a.*
			, lag(event_time) over (PARTITION BY user_id, recipe_id order by event_time ASC) as LG

		FROM
			(SELECT * from narnia_cp
			ORDER by 2,3,4) a
		) aa
	) aaa

WHERE CS_Notify in ('Y')

/* result 21,343 distint events where we can prompt cook snap */
